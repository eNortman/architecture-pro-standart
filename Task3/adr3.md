### <a name="_b7urdng99y53"></a>**Название задачи:** оформление депозита на сайте
### <a name="_hjk0fkfyohdk"></a>**Автор:**
### <a name="_uanumrh8zrui"></a>**Дата:**
### <a name="_3bfxc9a45514"></a>**Функциональные требования**
Опишите здесь верхнеуровневые Use Cases. Их нужно оформить в виде таблицы с пошаговым описанием:

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| :-: | :- | :- | :- |
|UC1  | Клиент на сайте |  подача заявки на сайте  | 1. пользователь из списка доступных депозитов переходит в форму подачи заявки <br> 2. пользователь заполняет информацию о себе <br> 3.При успешном приеме формы заявка подтверждается СМС кодом :<br> 3.1 Посредством телеком-оператора отправляется СМС <br> 3.2 Пользователь вводит полученную СМС <br> 4 Пользователю отображается страница с результатом операции и присвоенным номером заявления  | 
|UC2  | Клиент в интернет-банке |  авторизация в интернет-банке  | 1. Пользователь вводит логин (телефон), защитный код (captha) и пароль<br> 2. Посредством телеком-оператора отправляется СМС <br> 3. Пользователь вводит полученную СМС <br> 4.Платформа переводит пользователя на главную страницу    |
|UC3  | Клиент в интернет-банке |  выбор доступных депозитов  | 1. Пользователь с главной страницы переходит в раздел "депозиты" <br> 2. На странице депозитов пользователь видит список доступных депозитов - как персональные, так и общие для всех клиентов
|UC4  | Клиент в интернет-банке |  подача заявки на депозит  | 1. Пользователь выбирает предложение из списка <br> 2.Пользователь переводится на страницу (отображается окно) с информацией о депозите, формой для уточнения данных (сумма, срок) и кнопками потверждения и отмены  <br> 3. При нажатии на кнопку подтверждения и прохождении ФЛК пользователю отправляется посредством телеком-оператора смс сообщение.  <br> 4. Пользователь вводит в появившемся поле полученный код для подтверждения заявки  <br> 5. Пользователю отобрадается присвоенный номер заявки и информация по нему  |  |
|UC5  | Менеджер бэк-офиса |  обработка заявки на депозит  | 1. Менеджер подтверждает заявку <br> 2.АБС банка посредством системы телеком-оператора отправляет СМС-сообщение о статусе рассмотреня заявки |  |
### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**
Опишите здесь нефункциональные требования и архитектурно значимые требования.

|**№**|**Требование**|
| :-: | :- |
|**R**|**Надежность**|
|  | Избегать прямой работы интернет-банка с API АБС |
|  | Обеспечить доступность сервисов даже в отсутствии работы АБС |
|  | Обеспечить доступность сервисов при сбое ЦОД |
|**Р**|**Производительность**|
|  | Загрузка за несколько мс |
|**R**|**Ограничения**|
|  | Функционал согласования и ставок по депозитам вести в АБС |
|  | Использовать имеющийся стек АБС <br> - Delphi + Oracle - логика на PL/SQL <br> - Сайт - PHP + React <br>  - Интернет-банк ASP.NET MVC 4.5 + MSSQL <br> - есть система на Java + Spring Boot|


### <a name="_qmphm5d6rvi3"></a>**Решение**
Диаграммы контекста и контейнеров в модели C4. Там основные компоненты и интеграции всех элементов решения. 

С сайта снята функциональная нагрузка по интеграции с внутренними системами банка - фактически он оставлен самостоятельным компонентом.
Интернет-Банк интегрируется с АБС в части передачи заявок и событий изменения их статуса, а также уведомление о регистрации пользователей.

```plantuml
@startuml
title рис1. оформление депозита - диаграмма контекста 
top to bottom direction

!includeurl https://raw.githubusercontent.com/RicardoNiepel/C4-PlantUML/master/C4_Component.puml

Person(user, "Пользователь", "Клиент банка")
Person(oper, "Оператор", "Сотрудник бэк-офиса")
System(site, "Сайт")
System(dbank, "Интернет-банк")
System(abs, "АБС")
System(sms, "Шлюз телеком-оператора")

Rel(user, site, "заявка")
Rel(site, dbank, "Передача заявки в и-нет банк")


Rel(user, dbank, "заявка")
Rel(dbank, sms, "отправка смс")
Rel(dbank, abs, "заявки")

Rel(sms, user, "отправка смс")
Rel(oper, abs, "работа с заявкой на сайте")

@enduml
```

Преимущественно был оставлен стек актуальных технологий, использующ в актуальном решении. 
Так как фреймворм ASP.NET MVC устарел и не поддерживается, реализована возможность его плавной замены на актуальный и использующийся в решении (PHP + Redis) или новый путем вытеснения. Новые функции интернет-банка  предлагается реализовывать в компоненте "Интернет Банк API" совместно с клиентом (в качестве которого может выступать сайт).


Компонет "АБС API" решает интеграционные задачи синзронизации, а также реализует синхронизацию в менее загруженные периоды (ночью , например), чтобы снизить нагрузку на базу АБС.
АБС клиент на Delphi представляет собой толстый клиент к БД, размещаемый на каждом рабочем месте (компьютере) сотрудников бэк-офиса. На компонент клиента АБС не возлагается функционала по интеграции с внешними системами из-за возможных сложностей в эксплуатации такого решения

Для удовлетворения тербованиям быстродейтсвия можно применить собственные возможности ms-sql, типа in-memory-oltp. БД интернет банка используется для  "кешированния" данных о заявках, пользователях, депозитах и персональных предложениях. Синхронизация данных между интернет-банком и АБС осуществляется путем обмена сообщениями посредством брокера.

Надежность можно обеспечить путем репликации  базы (mssql это поддерживает) и создании экземпляров на разных ЦОД. В случае недоступности АБС и других backend систем интернет-банк останется работоспособен (хоть и не функционален до момента появления связи с backend).

Для обеспечения надёжности брокер также уместно развернуть в виде партиции в разных нодах для обеспечения надежности 

Использование очереди для интеграции со шлюзом обеспечит в будущем возможность расширения контроля за поступающими в шлюз сообщениями, возможности использования других способов оповещения (почта, звонок, мессенджер, пуш-уведомление и т.п.) а также относительно простую интеграцию возможности отправки СМС новыми сервисами в будущем.  

```plantuml
@startuml
title рис2. оформление депозита - диаграмма контейнера
top to bottom direction

!includeurl https://raw.githubusercontent.com/RicardoNiepel/C4-PlantUML/master/C4_Component.puml

Person(user, "Пользователь", "Клиент банка")

System(front_http, "nginx", "Фронтальный веб-сервер + маршрутизатор + балансир + HTTPS")
System(site, "Сайт", "PHP + ReactJS")

Container_Boundary(ibank_bnd, "Интернет-банк") {
    Container(ibnk_iis, "WebApp", "MS IIS", "Microsoft IIS со старым  ASP MVC приложением интернет-банка")

    ContainerDb(ibnk_db, "БД", "MS-SQL", "База данных Интернет-банка")

    Container(ibnk_web_cl, "WebClient", "Клиент нового веб-сайта, на которое будут переносится функции")
    Container(ibnk_web_srv, "Интернет Банк API", "Backend сервер интернет-банка")

    Rel(ibnk_iis, ibnk_db, "")
    Rel(ibnk_web_srv, ibnk_db, "")
    Rel(ibnk_web_cl, ibnk_web_srv, "")

}

ContainerQueue(qbroker, "Интеграционный брокер", "Kafka", "Интеграция между системами")

Person(oper, "Оператор", "Сотрудник бэк-офиса")

Container_Boundary(abs_bnd, "АБС") {
    Container(absapp, "АБС Клиент", "Delphi Client App", "Клиентской приложение оператора бэк-офиса")
    ContainerDb(abs_db, "БД", "OracleDb", "База данных АБС c логикой")
      
    Container(absapi, "AБС Api","","Сервер интеграции и обработки событий АБС")

    Rel(absapp, abs_db, "")
    Rel(absapi, abs_db, "")
}

Rel(oper, absapp, "")

System(sms, "Шлюз телеком-оператора")

Rel(ibnk_web_srv, qbroker, "" )
Rel(absapi, qbroker, "" )

Rel(user, front_http, "соединение до внутреннего контура банка защищено https")
Rel(front_http, ibnk_iis, "")

Rel(front_http, site, "")
Rel(front_http, ibnk_web_cl, "")

Rel(qbroker, sms, "сообщения для отправки")


SHOW_LEGEND()

@enduml
```

### <a name="_bjrr7veeh80c"></a>**Альтернативы**
1.Можно на Сайт возложить функционал по интеграции с АБС и СМС шлюзом, но это создасть ненужное дублирование аналогичного функционлала интернет-банка 
```plantuml
@startuml
title рис3.оформление депозита (альтернатива с формой на сайте)
' top to bottom direction

!includeurl https://raw.githubusercontent.com/RicardoNiepel/C4-PlantUML/master/C4_Component.puml

Person(user, "Пользователь", "Клиент банка")
Person(oper, "Оператор", "Сотрудник бэк-офиса")
System(site, "Сайт")
System(dbank, "Интернет-банк")
System(abs, "АБС")
System_Ext(sms, "Шлюз телеком-оператора")

Rel(user, site, "Размещает заявку")
Rel(site, abs, "Передача заявки")
Rel(site, sms, "отправка смс")
Rel(sms, user, "отправка смс")
Rel(oper, abs, "работа с заявкой на сайте")

Rel(user, dbank, "работа с заявкой в и-нет банке")
Rel(dbank, sms, "отправка смс")
Rel(dbank, abs, "Передача заявки")

@enduml
```

2. Возможно развитие сайта как клиентской части интернет-банка


```plantuml
@startuml
title рис 4. оформление депозита - альтернатива с формой на сайте
top to bottom direction

!includeurl https://raw.githubusercontent.com/RicardoNiepel/C4-PlantUML/master/C4_Component.puml

Person(user, "Пользователь", "Клиент банка")

System(front_http, "nginx", "Фронтальный веб-сервер + маршрутизатор + балансир + HTTPS")
System(site, "Сайт", "PHP + ReactJS")

Container_Boundary(ibank_bnd, "Интернет-банк") {
    Container(ibnk_iis, "WebApp", "MS IIS", "Microsoft IIS со старым  ASP MVC приложением интернет-банка")

    ContainerDb(ibnk_db, "БД", "MS-SQL", "База данных Интернет-банка")

    Container(ibnk_web_srv, "Интернет Банк API", "Backend сервер интернет-банка")

    Rel(ibnk_iis, ibnk_db, "")
    Rel(ibnk_web_srv, ibnk_db, "")
    Rel(site, ibnk_web_srv, "использование сайта в качестве клиента интенет-банка")

}

ContainerQueue(qbroker, "Интеграционный брокер", "Kafka", "Интеграция между системами")

Person(oper, "Оператор", "Сотрудник бэк-офиса")

Container_Boundary(abs_bnd, "АБС") {
    Container(absapp, "АБС Клиент", "Delphi Client App", "Клиентской приложение оператора бэк-офиса")
    ContainerDb(abs_db, "БД", "OracleDb", "База данных АБС c логикой")
      
    Container(absapi, "AБС Api","","Сервер интеграции и обработки событий АБС")

    Rel(absapp, abs_db, "")
    Rel(absapi, abs_db, "")
}

Rel(oper, absapp, "")

System(sms, "Шлюз телеком-оператора")

Rel(ibnk_web_srv, qbroker, "" )
Rel(absapi, qbroker, "" )

Rel(user, front_http, "соединение до внутреннего контура банка защищено https")
Rel(front_http, ibnk_iis, "")

Rel(front_http, site, "")

Rel(qbroker, sms, "сообщения для отправки")

@enduml
```


**Недостатки, ограничения, риски**

- необходимо привлечение большого числа специалистов для доработки практически каждого модуля. Понадобится дообучение персонала или расширение штата разработчиков
- ограничение на задействование старого стека может не дать нужного быстродействия и потребует применение других решений - например, в интернет-банке использование решения in-memory-oltp. Также это решение может стать компромиссным при использовании современных распространенных решений в сравнении с затратами на привлечение специалиста по pl/sql.

